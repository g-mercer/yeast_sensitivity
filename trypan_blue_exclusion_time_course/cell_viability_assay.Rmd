---
title: "cell_viability_assay"
author: "Guy Mercer"
date: "04/04/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(rstatix)
library(ggtext)
```

```{r}
viability_data <- read_csv("input/trypan_blue_counts.csv")

# subset data by each timepoint
time <- c("10m", "30m", "1h", "2h", "4h")

timepoint_split_fun <- function(x) {
  
  timepoints_list <- list()

  for (i in 1:length(time)) {
  
    timepoint <- x [grep(pattern = time [i], x = x$Sample), ]

    timepoints_list [[i]] <- timepoint
  }

  return(timepoints_list)

}

timepoints_list <- timepoint_split_fun(viability_data)


# subset data by timepoint and treatment
treatment <- c("cont", "mala", "thia")

list_of_treatment_lists <-list()
for (i in 1:length(timepoints_list)) {
  
  treatment_list <- list()
  for (k in 1:length(treatment)) {
    
    by_treatment <- timepoints_list [[i]] [grep(pattern = treatment [k], x = timepoints_list [[i]]$Sample), ]
    
    treatment_list [[k]] <- by_treatment
    
  }
  
  list_of_treatment_lists [[i]] <- treatment_list
  
}

# sum the groups' columns
combined_group_data <- matrix(0, nrow = 1, ncol = 4)

for (i in 1:length(list_of_treatment_lists)) {
  
  for (k in 1:length(treatment)) {
    
    by_group <- as.data.frame(list_of_treatment_lists [[i]] [k])
    
    col_sums <- c(by_group [1,1],colSums(by_group [,2:4]))
    
    combined_group_data <- rbind(combined_group_data, col_sums)
    
  }
  
}

# tidy up the dataframe and correct one of the sample names
combined_group_data <- combined_group_data [2:16,]
colnames(combined_group_data) [1] <- "Sample"
combined_group_data [13,1] <- "cont-4h"
rownames(combined_group_data) <- combined_group_data [,1]


# get into numeric again
combined_group_data <- as.data.frame(combined_group_data)
combined_group_data$Viable <-  as.numeric(as.character(combined_group_data$Viable))
combined_group_data$Non.Viable <-  as.numeric(as.character(combined_group_data$Non.Viable))
combined_group_data$Total <-  as.numeric(as.character(combined_group_data$Total))

# split by timepoint into list again
for_stats <- timepoint_split_fun(combined_group_data)
```

Now perform fisher's exact test for each timepoint. Do a post hoc comparison but ignore the thia vs mala because we aren't interested in it. Adjust p values accordingly. 

```{r}
# load package
library(RVAideMemoire)

fisher_output <- list()

for (i in 1:length(for_stats)) {
  
  fisher_df <- as.matrix(for_stats [[i]] [,2:3])

rownames(fisher_df) <- for_stats [[i]] [,1]


fisher.test(fisher_df,
            alternative="two.sided")

library(rcompanion)

pt <- pairwiseNominalIndependence(fisher_df,

                                 fisher = TRUE,

                                 gtest  = FALSE,

                                 chisq  = FALSE,
                                 digits = 3)

fisher_output [[i]] <- pt [1:2,1:2]
  
}

# adjust p values correctly by removing mala-thia comparison and correcting for only two comparisons, not 3.

for (i in 1:length(fisher_output)) {
  
# perform FDR correction. Set a 5% false discovery rate
fdr <- p.adjust(fisher_output [[i]]$p.Fisher, method = "fdr", n = length(fisher_output [[1]]$p.Fisher))

fisher_output [[i]] <- cbind(fisher_output [[i]],fdr)

}

```

Display this information graphically. Y axis is non-viable cells over total cells. X axis is time. Pop significance stars from the fisher's exact test above the corresponding points (with a line joining the pairs)?

```{r}

# to use stat_pvalue_manual I have to create an appropriately formatted dataframe. 
mult_comp_combined <- tibble()

# put fisher output into df
for (i in 1:length(fisher_output)) {
  
  mult_comp_combined <- rbind(mult_comp_combined, fisher_output [[i]])

}
  
mult_comp_combined <- mult_comp_combined [,c(1,3)]

# split the first column into two, one for each group being compared.
split_list <- str_split(mult_comp_combined$Comparison, pattern = " : ")

group_names <- tibble()

for (i in 1:length(split_list)) {
  
  group1 <- split_list [[i]] [1]
  
  group_names [i, 1] <- group1
  
  group2 <- split_list [[i]] [2]
  
  group_names [i, 2] <- group2
  
}

# combine relevant group names with p.adj
fstat_pvalue_manual_df <- cbind(group_names, mult_comp_combined [,2])
colnames(fstat_pvalue_manual_df) <- c("group1", "group2", "p.adj")

# add significance stars
fstat_pvalue_manual_df <- add_significance(fstat_pvalue_manual_df)

# give combined group data a time and proportion of non-viable over total column 
time_min <- c(10, 30, 60, 120, 240)

groups_split <- timepoint_split_fun(combined_group_data)

with_time_min_col <- tibble()

for (i in 1:length(time_min)) {
  
  groups_split [[i]] $time <- time_min [i]
  
  with_time_min_col <- rbind(with_time_min_col, groups_split [[i]])
  
}

with_time_min_col$non_viable_proportion <- with_time_min_col$Non.Viable / with_time_min_col$Total

# give with_time_min_col a treatment column
insecticide_names_only <- gsub(pattern = "-[[:digit:]]+[[:alpha:]]+", replacement = "", x = with_time_min_col$Sample)

with_time_min_col$insecticide <- insecticide_names_only

# set insecticide as a factor and relevel
with_time_min_col$insecticide <- as.factor(with_time_min_col$insecticide)
with_time_min_col$insecticide <- relevel(with_time_min_col$insecticide, "cont")

# plot curve
library(ggpubr)
library(viridis)

cairo_pdf(file = "/Users/guy/Documents/phd/DEG_yeast_insecticide_expt/trypan_blue_exclusion_time_course/timecourse.pdf",   # The directory you want to save the file in
    width = 6, # The width of the plot in inches
    height = 4) # The height of the plot in inches

# plotting the curve
  ggplot(with_time_min_col, aes(x = time, y = non_viable_proportion, colour = as.factor(insecticide))) +
  
  geom_point() +
  
  xlab("Time (m)") + ylab("Non-Viable/Total Cells") +
    
  ylim(0, 1) +
  
# Avoid the nasty default theme
  theme_bw() + 
  
  scale_x_continuous(breaks=c(10,30, 60, 120, 240)) +

# give the legend a title
  guides(colour = guide_legend(title="Treatment")) +
  
  geom_line() +
  
  scale_colour_manual(values = c("#F0E442", "#009E73", "#0072B2")) +
  
  theme(panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    
  annotate("text", x = 30, y = 0.315, label = "****", hjust = 1) +
  
  annotate("text", x = 60, y = 0.42, label = "****", hjust = 1) +
    
  annotate("text", x = 120, y = 0.65, label = "****", hjust = 1) +
    
  annotate("text", x = 240, y = 0.785, label = "****", hjust = 1) +
  
  annotate("text", x = 120, y = 0.065, label = "*", hjust = 1) +
    
  annotate("text", x = 240, y = 0.13, label = "****", hjust = 1) +
    
  ggtitle("*pdr1∆ pdr3∆* Cell Viability Over 4 Hours Insecticide Treatment") +
    
  theme(plot.title = element_text(hjust = 0.5)) +
    
  theme(plot.title = ggtext::element_markdown())

  dev.off()
```

```{r}
# testing mala 2h against the highest control of any timepoint.
mala_sig_check <- rbind(for_stats [[2]] [1,], for_stats [[4]] [2,])

fisher_df_mala_sig_check <- as.matrix(mala_sig_check[,2:3])

rownames(fisher_df_mala_sig_check) <- mala_sig_check [,1]

fisher.test(fisher_df_mala_sig_check,
            alternative="two.sided")
```

```{r}
# supplementary tables
NVPs <- with_time_min_col [,2:6]

write.csv(NVPs, "~/Documents/phd/DEG_yeast_insecticide_expt/trypan_blue_exclusion_time_course/proportions.csv", row.names = TRUE)

complete_fisher_df <- tibble()

for (i in 1:length(fisher_output)) {
  
  fisher_output_timepoint <- fisher_output [[i]]
  
  complete_fisher_df <- rbind(complete_fisher_df, fisher_output_timepoint)
} 

write.csv(complete_fisher_df, "~/Documents/phd/DEG_yeast_insecticide_expt/trypan_blue_exclusion_time_course/fisher_pairwise_comps.csv", row.names = FALSE)
```

